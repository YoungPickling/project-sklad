<app-alert
  *ngIf="alertOpen"
  [(isLoadig)]="isLoading"
  [preset]="alertPreset"
  [message]="error"
  [error]="errorResponse"
  [confirmMessage]="alertItemName"
  [confirmField]="confirmField"
  [tempId]="tempId"
  [imageList]="imageList"
  (close)="onCloseAlert()"
  (removeItemImage)="onUpdateItemImage(-1)"
  (setItemImage)="onUpdateItemImage($event)"
></app-alert>

<div style="margin-left: 1rem">
  <div class="w-title-bar">
    <h1 class="w-title">Items</h1>
    <span *ngIf="isLoading" class="loader-round"></span>
  </div>

  <div>
    <button
      class="button-42" 
      [ngClass]="{'button-42-active': addButtonActive}"
      (click)="onClickAddBtn()"
    >Add Row</button>

    <button 
      class="button-42" 
      [ngClass]="{'button-42-active': removeButtonActive}"
      [disabled]="company?.items?.length === 0"
      (click)="onClickRemoveBtn()"
    >Delete Row</button>
  </div>

  <div *ngIf="!isLoading && addButtonActive">
    <hr/>
    <form [formGroup]="addItemForm" (ngSubmit)="onSubmitAddItem()">
      <div class="w-form-container">
        <div class="input-container">
          <input placeholder="code" formControlName="code" class="input-field" type="text" autocomplete="false" />
          <label for="code" class="input-label">code</label>
          <span class="input-highlight"></span>
        </div>

        <div class="input-container">
          <input placeholder="name" formControlName="name" class="input-field" type="text" autocomplete="false" />
          <label for="name" class="input-label">name</label>
          <span class="input-highlight"></span>
        </div>

        <div class="input-container" style="margin-right:0;">
          <input type="color" value="#ffffff" formControlName="color" class="input-color" />
          <label for="color" class="input-label">color</label>
        </div>
        
        <div class="input-container">
          <input placeholder="description" formControlName="description" class="input-field" type="text" autocomplete="false" />
          <label for="description" class="input-label">description</label>
          <span class="input-highlight"></span>
        </div>
      </div>

      <div formArrayName="columns">
        <p *ngIf="columns?.controls?.length > 0">Rows:</p>
        <div 
          *ngFor="let columnControl of columns.controls; let i = index; let even = even" 
          class="w-form-container"
          [ngStyle]="{'background-color': even ? '#fff' : '#e3e9f2'}"
          [formGroupName]="i"
          >
          <div class="input-container">
            <input id="name-{{i}}" placeholder="column name" formControlName="name" class="input-field" type="text" autocomplete="false" />
            <label for="name-{{i}}" class="input-label">column name</label>
            <span class="input-highlight"></span>
          </div>
    
          <div class="input-container">
            <input id="value-{{i}}" placeholder="value" formControlName="value" class="input-field" type="text" autocomplete="false" />
            <label for="value-{{i}}" class="input-label">value</label>
            <span class="input-highlight"></span>
          </div>
    
          <div class="input-container" style="margin-right:0;">
            <input id="color-{{i}}" formControlName="color" class="input-color" type="color" value="#ffffff" />
            <!-- <label for="color-{{i}}" class="input-label">Color</label> -->
          </div>
          
          <div class="input-container">
            <input id="width-{{i}}" placeholder="column width" formControlName="width" class="input-field" type="text" autocomplete="false" />
            <label for="width-{{i}}" class="input-label">column width</label>
            <span class="input-highlight"></span>
          </div>

          <div class="input-container" style="align-content:center; margin-right:0">
            <div class="w-form-button" (click)="removeColumn(i)"> 
              <!-- (click)="columns.controls.splice(i, 1)" - with this approach, once you add a column with empty fields and delete it right after, you can't submit the form -->
              <mat-icon>close</mat-icon>
            </div>
          </div>
        </div>
      </div>
      
      <div class="w-form-submit-box">
        <button class="button-42" type="button" (click)="addColumn()">Add Column</button>
        <button class="button-42" type="submit" [disabled]="addItemForm.invalid && !isLoading">Submit</button>
      </div>
    </form>
    <hr/>
  </div>

<!-- <span class="loader" *ngIf="isLoading"></span> -->
</div>
<h1 class="w-empty" *ngIf="company?.items?.length === 0 else view">No items created yet</h1>

<ng-template #view>
  <div class="w-table-container"> 
    <table class="workspace-table">
      <thead>
        <tr>
          <th *ngIf="removeButtonActive" class="ws-icon-cell">
            <div>
              <mat-icon>delete</mat-icon>
            </div>
          </th>
          <th></th>
          <th>code</th>
          <th>name</th>
          <th>description</th>
          <th 
            *ngFor="let el of customColumns | keyvalue"
            [ngStyle]="{
              'background-color': 'khaki', 
              'color': 'black',
              'min-width': el.value?.width + 'px'
              }"
          >{{ el.key }}</th>
          <!-- 'background-color': el.value?.color, 
              'color': onFontColor(el.value?.color), 
              class="w-suppliers" -->
          <th
            *ngFor="let location of company?.locations"
            class="ws-icon-cell"
          >
            <div>
              <mat-icon style="margin-right: 0.2rem;">warehouse</mat-icon>
              {{ location?.name }}
            </div>
          </th>

          <th
            *ngFor="let supplier of company?.suppliers"
            class="ws-icon-cell ws-even-cell"
          >
            <div>
              <mat-icon style="margin-right: 0.2rem;">local_shipping</mat-icon>
              {{ supplier?.name }}
            </div>
          </th>
          <!-- *ngFor="let location of company?.locations" -->
          <!-- ><mat-icon>warehouse</mat-icon>{{ location }}</th> -->
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of items; let i = index">
          <td *ngIf="removeButtonActive">
            <input 
              type="checkbox" 
              id="r{{i}}" 
              name="remove" 
              class="ws-check-box"
              (change)="onCheckboxChange($event, item?.id)"/>
          </td>
          <td style="padding:0;">
            <div class="cell-image-wrap">
              <div 
                *ngIf="!item?.image" 
                class="cell-empty-image" 
                [ngStyle]="{'background-color': 
                  i % 6 === 0 ? 'crimson' : 
                  i % 6 === 1 ? 'gold' : 
                  i % 6 === 2 ? 'limegreen' :  
                  i % 6 === 3 ? 'lightskyblue' : 
                  i % 6 === 4 ? 'royalblue' : 'darkviolet'}"
              >
                <mat-icon>add_a_photo</mat-icon>
              </div>

              <!-- [ngStyle]="{'background-image': 'url(' + link + item?.image?.hash + ')'}" -->
              <div 
                *ngIf="item?.image"
                class="cell-empty-image"
                [cacheSrc]="link + item?.image?.hash"
              ></div>
              

              <div (clickOutside)="onClickOutsideImageContextMenu(i)">
                <div 
                  title="Change image" 
                  (click)="onOpenImageContext(i)"
                  [ngClass]="{'to-block': rowImageContextMenu[i]}" 
                  class="cell-image-hover-button" 
                >
                  <mat-icon>expand_more</mat-icon>
                </div>

                <div class="cell-image-context-menu" *ngIf="rowImageContextMenu[i]">
                  <div (click)="onClickSelectImageFromGallery(i)">select from gallery</div>
                  <div *ngIf="item?.image?.hash" (click)="onClickRemoveItemImage(i)">remove</div>
                </div>
              </div>
            </div>
          </td>
          <td 
            [ngClass]="{'cell-edit-border': cellEditMode[i + '-0']}"
            (click)="doubleClickCell(i,0)"
          >
            <div
              [id]="i + '-0'"
              *ngIf="!cellEditMode[i + '-0']"
              >{{ item?.code }}</div>
            <span
              [id]="i + '-0f'"
              *ngIf="cellEditMode[i + '-0']" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-0')"
              (keydown.enter)="updateCellValue(i, 0)"
              contenteditable
            ></span>
          </td>
          <td 
            [ngClass]="{'cell-edit-border': cellEditMode[i + '-1']}"
            (click)="doubleClickCell(i,1)"
          >
            <div
              [id]="i + '-1'"
              *ngIf="!cellEditMode[i + '-1']"
              >{{ item?.name }}</div>
            <span
              [id]="i + '-1f'"
              *ngIf="cellEditMode[i + '-1']" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-1')"
              (keydown.enter)="updateCellValue(i, 1)"
              contenteditable
            ></span>
          </td>
          <td 
            [ngClass]="{'cell-edit-border': cellEditMode[i + '-2']}"
            (click)="doubleClickCell(i,2)"
          >
            <div
              [id]="i + '-2'"
              *ngIf="!cellEditMode[i + '-2']"
              >{{ item?.description }}</div>
            <span
              [id]="i + '-2f'"
              *ngIf="cellEditMode[i + '-2']" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-2')"
              (keydown.enter)="updateCellValue(i, 2)"
              contenteditable
            ></span>
          </td>
          <!--  -->
          <td 
            *ngFor="let el of customColumns | keyvalue; let ii = index"
            (click)="doubleClickCell(i,ii+3)"
            [ngClass]="{'cell-edit-border':cellEditMode[i + '-' + (ii+3)]}"
          >
            <div
              [id]="i + '-' + (ii+3)"
              *ngIf="!cellEditMode[i + '-' + (ii+3)]"
            >{{ getItemColumnValue(item, el.key) }}</div>
            <span
              [id]="i + '-' + (ii+3) + 'f'"
              *ngIf="cellEditMode[i + '-' + (ii+3)]" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-' + (ii+3))"
              (keydown.enter)="updateCellValue(i, ii+3)"
              contenteditable
            ></span>
          </td>

          <td
            *ngFor="let location of company?.locations; let ii = index"
            (click)="doubleClickCell(i, ii + locationPostfix)"
            [ngClass]="{'cell-edit-border':cellEditMode[i + '-' + (ii + locationPostfix)]}"
          >
            <div
              [id]="i + '-' + (ii + locationPostfix)"
              *ngIf="!cellEditMode[i + '-' + ii + locationPostfix]"
            ></div>
            <span
              [id]="i + '-' + (ii + locationPostfix) + 'f'"
              *ngIf="cellEditMode[i + '-' + (ii + locationPostfix)]" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-' + (ii + locationPostfix))"
              (keydown.enter)="updateCellValue(i, ii + locationPostfix)"
              contenteditable
            ></span>
          </td>

          <td
            *ngFor="let supplier of company?.suppliers; let ii = index"
            (click)="doubleClickCell(i, ii + supplierPostfix)"
            [ngClass]="{'cell-edit-border':cellEditMode[i + '-' + (ii + supplierPostfix)]}"
          >
            <div
              [id]="i + '-' + (ii + supplierPostfix)"
              *ngIf="!cellEditMode[i + '-' + ii + supplierPostfix]"
            ></div>
            <span
              [id]="i + '-' + (ii + supplierPostfix) + 'f'"
              *ngIf="cellEditMode[i + '-' + (ii + supplierPostfix)]" 
              [(inputValue)]="tempCellValue"
              (clickOutside)="onClickOutsideCell(i + '-' + (ii + supplierPostfix))"
              (keydown.enter)="updateCellValue(i, ii + supplierPostfix)"
              contenteditable
            ></span>
          </td>

        </tr>
      </tbody>
    </table>
  </div>
</ng-template>

<button
  *ngIf="removeButtonActive"
  class="button-42" 
  [disabled]="isLoading || itemsToDelete.size == 0"
  (click)="onRemoveRows()"
>Submit Removal</button>